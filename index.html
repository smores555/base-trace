<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Base Trace v32 — BPL Enabled</title>
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:#0b1220;color:#eaf2ff}
    .banner{background:#0e2a4c;border-bottom:3px solid #8ad2ff;color:#fff;padding:10px;font-weight:800;border-radius:0 0 12px 12px}
    .wrap{max-width:1240px;margin:18px auto;padding:0 12px 42px}
    .card{background:#111a2b;border:1px solid #1f2a44;border-radius:14px;padding:12px;margin-bottom:12px}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:10px 0}
    button{background:#2e4a78;color:#fff;border:1px solid #1f2a44;border-radius:10px;padding:8px 12px;font-weight:600;cursor:pointer}
    button.secondary{background:#203453}
    input[type=number]{width:86px;padding:6px;border-radius:8px;border:1px solid #1f2a44;background:#0b1426;color:#eaf2ff;font-size:14px}
    pre{background:#0f182a;border:1px solid #1f2a44;padding:8px;border-radius:8px;max-height:260px;overflow:auto}
  </style>
</head>
<body>
  <div class="banner">Base Trace v32 — Vacancy + Cascade + BPL Active</div>
  <div class="wrap">
    <div class="toolbar">
      <button id="runBtn">Run (Vacancy → Cascade)</button>
      <button id="resetBtn" class="secondary">Reset</button>
      <span id="status"></span>
    </div>
    <div id="capTable" class="card"></div>
    <div class="card">
      <h3>Trace</h3>
      <pre id="trace"></pre>
    </div>
  </div>
<script>
// === load data ===
async function loadJSON(f){const r=await fetch(f+"?t="+Date.now());if(!r.ok)throw new Error("load fail "+f);return r.json();}
let capacities=[], roster=[], prefs={};
async function boot(){
  capacities=await loadJSON("capacities.json");
  roster=await loadJSON("roster.json");
  const pf=await loadJSON("preferences.json");
  pf.forEach(p=>prefs[p.sen]=p);
  renderCap(); document.getElementById('status').textContent="Loaded.";
}
function renderCap(){
  const t=document.createElement('table');
  t.innerHTML='<tr><th>Base</th><th>Seat</th><th>StartCap</th><th>Δ</th></tr>'+
    capacities.map(c=>`<tr><td>${c.base}</td><td>${c.seat}</td><td>${c.startCapacity}</td><td>${c.delta}</td></tr>`).join("");
  document.getElementById('capTable').innerHTML=''; document.getElementById('capTable').appendChild(t);
}
// === core bid logic skeleton ===
let Occupants=new Map();
function initOcc(){Occupants.clear();capacities.forEach(c=>{Occupants.set(c.base+"__"+c.seat,new Set());});roster.forEach(p=>{const k=p.current.base+"__"+p.current.seat;if(!Occupants.has(k))Occupants.set(k,new Set());Occupants.get(k).add(p.sen);});}
function bplSatisfied(p,toKey,toBase,toSeat){
  const entry=(prefs[p.sen]?.preferences||[]).find(x=>x.base===toBase&&x.seat===toSeat);
  const limit=entry?.bpl_min;
  if(limit==null)return {ok:true,reason:null};
  const occ=Occupants.get(toKey)||new Set();
  const rank=[...occ].filter(s=>s<p.sen).length+1;
  if(rank>limit)return {ok:false,reason:`Projected rank ${rank} > BPL ${limit}`};
  return {ok:true,reason:null};
}
function run(){
  initOcc();
  const trace=document.getElementById('trace');trace.textContent='';
  for(const p of roster){
    const pref=(prefs[p.sen]?.preferences||[]);
    for(const w of pref){
      const toKey=w.base+'__'+w.seat;
      const chk=bplSatisfied(p,toKey,w.base,w.seat);
      trace.textContent+=`Pilot ${p.name} bidding ${w.base} ${w.seat}: `+(chk.ok?'OK':'BLOCKED '+chk.reason)+'\n';
    }
  }
}
document.getElementById('runBtn').onclick=run;
document.getElementById('resetBtn').onclick=boot;
boot();
</script>
</body></html>