<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Bases Bid — v31-look + BPL + Editable Capacities</title>
<style>
  :root{--bg:#0b1220;--card:#111a2b;--muted:#8aa4c1;--text:#eaf2ff;--accent:#8ad2ff;--border:#1f2a44}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:1200px;margin:20px auto;padding:0 12px 48px}
  .banner{background:#0e2a4c;color:#fff;border-bottom:3px solid var(--accent);padding:10px 12px;font-weight:800;border-radius:0 0 12px 12px}
  .grid{display:grid;gap:12px;grid-template-columns:360px 1fr}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px}
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:8px 0}
  button{background:#2e4a78;color:#fff;border:1px solid var(--border);border-radius:10px;padding:8px 12px;font-weight:600;cursor:pointer}
  button.secondary{background:#203453}
  input[type=number],input[type=text]{padding:6px;border-radius:8px;border:1px solid var(--border);background:#0b1426;color:#eaf2ff;font-size:14px}
  table{width:100%;border-collapse:separate;border-spacing:0 6px}
  th{font-size:12px;color:var(--muted);text-align:left;padding:4px 8px}
  td{background:#0f182a;border:1px solid var(--border);padding:6px 8px;vertical-align:middle}
  .basehdr{background:#13213a;color:#cfe6ff;font-weight:700}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono','Courier New', monospace}
  .cols{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .list{max-height:360px;overflow:auto;white-space:pre-wrap}
  .subtle{color:var(--muted)}
</style>
</head>
<body>
  <div class="banner">Bases Bid — v31 look • BPL • Editable Capacities</div>
  <div class="wrap">
    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <div class="toolbar">
          <button id="runBtn">Run</button>
          <button class="secondary" id="reloadBtn">Reload JSON</button>
          <span id="status" class="subtle mono"></span>
        </div>
        <h3>Capacities (edit here)</h3>
        <div class="subtle" style="margin-bottom:6px">Edit <b>Start</b> (incumbents) and <b>Δ</b> (posted adds). CA Δ seeds vacancies; FO Δ optional.</div>
        <label class="subtle mono" style="display:block;margin:6px 0">
          <input type="checkbox" id="allowFoDelta"> Allow FO Δ to create vacancies
        </label>
        <div id="capTable"></div>
        <h3 style="margin-top:14px">Pilot Trace</h3>
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:6px">
          <input id="traceQuery" placeholder="e.g., 1010 or SMITH, JASON" style="width:240px">
          <label class="subtle mono"><input type="checkbox" id="traceEnabled"> Enable</label>
          <button class="secondary" id="traceClear">Clear log</button>
        </div>
        <pre id="traceLog" class="mono list" style="background:#0f182a;border:1px solid var(--border);padding:8px;border-radius:8px"></pre>
      </div>

      <!-- RIGHT -->
      <div>
        <div class="cols">
          <div class="card">
            <h3>Open Vacancies</h3>
            <div id="openVac"></div>
          </div>
          <div class="card">
            <h3>Names (Seniority)</h3>
            <div id="namesBySen" class="mono list" style="background:#0f182a;border:1px solid var(--border);padding:8px;border-radius:8px"></div>
          </div>
        </div>
        <div class="card" style="margin-top:12px">
          <h3>Vacancy Ledger</h3>
          <div style="max-height:340px;overflow:auto">
            <table>
              <thead><tr class="subtle"><th>Pass</th><th>Action</th><th>Pilot</th><th>From</th><th>To</th></tr></thead>
              <tbody id="ledgerBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
// ===== constants/helpers
const BASES=["SEA","ANC","PDX","SFO","LAX"];
const SEATS=["CA","FO"];
const key=(b,s)=>`${String(b).toUpperCase()}__${String(s).toUpperCase()}`;
const q=s=>String(s||'').trim().toUpperCase();

let roster=[], prefs={}, capMap=new Map();
const state={running:false, pass:0, moves:[]};

// vacancies
const Vac=new Map();
const vacAmt=k=>Vac.get(k)||0;
const vacInc=(k,n=1)=>Vac.set(k,(Vac.get(k)||0)+n);
const vacDec=(k,n=1)=>Vac.set(k,Math.max(0,(Vac.get(k)||0)-n));

// priority seats that opened
const NewlyOpened=new Set();
const noteOpen=k=>NewlyOpened.add(k);
const drainNewlyOpened=()=>{const a=[...NewlyOpened]; NewlyOpened.clear(); return a;};

// live occupants for BPL
const Occupants=new Map();
function seedOccupants(){
  Occupants.clear();
  for (const p of roster){
    const k=key(p.current.base,p.current.seat);
    if(!Occupants.has(k)) Occupants.set(k,new Set());
    Occupants.get(k).add(p.sen);
  }
}
function moveOcc(p,fromK,toK){
  if(fromK){ const s=Occupants.get(fromK); if(s) s.delete(p.sen); }
  if(!Occupants.has(toK)) Occupants.set(toK,new Set());
  Occupants.get(toK).add(p.sen);
}

// preferences
function prefEntryFor(p){
  if(p && p.id && prefs[p.id]) return prefs[p.id];
  const senStr=String(p?.sen ?? '');
  if (prefs[senStr]) return prefs[senStr];
  const pilKey='pil'+senStr;
  if (prefs[pilKey]) return prefs[pilKey];
  return null;
}
function sameChoice(db,ds,cb,cs){ db=q(db); ds=q(ds); cb=q(cb); cs=q(cs); if(!db||!cb) return false; if(db!==cb) return false; if(!ds) return true; return ds===cs; }
function rankPrefs(p){
  const pe=prefEntryFor(p);
  const list=(pe?.preferences||[]).slice().filter(x=>x && x.stay!==true);
  list.sort((a,b)=>(a.order||0)-(b.order||0));
  let stop=-1;
  for(let i=0;i<list.length;i++){
    if (sameChoice(list[i].base,list[i].seat,p.current.base,p.current.seat)){ stop=i; break; }
  }
  return stop>=0 ? list.slice(0,stop+1) : list;
}
function prefRank(p, base, seat){
  const list=rankPrefs(p);
  for (let i=0;i<list.length;i++){
    const w=list[i]; if (q(w.base)===q(base) && q(w.seat)===q(seat)) return (w.order ?? (i+1));
  }
  return Infinity;
}
const pinned=new Set();
const bestRank=new Map();

// BPL enforcement
function bplSatisfied(p, w, toK){
  const min=Number(w.bpl_min||0);
  if (!min) return {ok:true, reason:null};
  const occ=Occupants.get(toK)||new Set();
  let seniorsAhead=0; for (const sen of occ) if (sen < p.sen) seniorsAhead++;
  const projectedPos=seniorsAhead+1;
  const ok=projectedPos<=min;
  return ok ? {ok:true, reason:null} : {ok:false, reason:`projected position ${projectedPos} > BPL ${min}`};
}

// UI rendering
function groupByBase(){
  const bases={};
  for(const [k,c] of capMap.entries()){ (bases[c.base] ||= []).push(c.seat); }
  for(const b of Object.keys(bases)){ bases[b]=Array.from(new Set(bases[b])).sort(); }
  return Object.keys(bases).sort().map(b=>({base:b,seats:bases[b]}));
}
function renderCapTable(){
  const groups=groupByBase();
  let html='<table><thead><tr><th>Base</th><th>Seat</th><th>Start</th><th>Δ</th><th>Adjusted</th></tr></thead><tbody>';
  for (const g of groups){
    const rs=g.seats.length;
    g.seats.forEach((seat,idx)=>{
      const c=capMap.get(key(g.base,seat));
      const adj=(c?.start||0)+(c?.delta||0);
      html+='<tr>';
      if(idx===0) html+=`<td class="basehdr" rowspan="${rs}">${g.base}</td>`;
      html+=`<td>${seat}</td>`;
      html+=`<td><input type="number" value="${c?.start||0}" oninput="onStart('${g.base}','${seat}',this.value)"></td>`;
      html+=`<td><input type="number" value="${c?.delta||0}" oninput="onDelta('${g.base}','${seat}',this.value)"></td>`;
      html+=`<td class="mono">${adj}</td>`;
      html+='</tr>';
    });
  }
  html+='</tbody></table>';
  document.getElementById('capTable').innerHTML=html;
}
window.onStart=(b,s,v)=>{ const k=key(b,s); const c=capMap.get(k)||{base:b,seat:s,start:0,delta:0}; c.start=+v||0; capMap.set(k,c); renderCapTable(); seedVacFromCap(); };
window.onDelta=(b,s,v)=>{ const k=key(b,s); const c=capMap.get(k)||{base:b,seat:s,start:0,delta:0}; c.delta=+v||0; capMap.set(k,c); renderCapTable(); seedVacFromCap(); };

function renderOpen(){
  const items=[...Vac.entries()].filter(([,v])=>v!==0).sort((a,b)=>a[0].localeCompare(b[0]));
  document.getElementById('openVac').innerHTML = items.map(([k,v])=>{
    const [b,s]=k.split('__'); const sign=v>0?'+':''; return `<div class="mono">${b} ${s}: ${sign}${v}</div>`;
  }).join('') || '<div class="subtle">No open vacancies</div>';
}
function renderNamesBySeniority(){
  const slot=document.getElementById('namesBySen'); if(!slot) return;
  const bySen=[...state.moves].sort((a,b)=>(a.sen||1e9)-(b.sen||1e9));
  slot.textContent=bySen.map(m=>`${m.sen} ${m.name||''} — ${m.fromB} ${m.fromS} → ${m.toB} ${m.toS}`).join('\n');
}
function renderLedgerRows(rows){
  if(!rows.length) return;
  const tb=document.getElementById('ledgerBody');
  const frag=document.createDocumentFragment();
  for(const r of rows){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td class="mono">${r.pass}</td><td>${r.action}</td><td>${r.pilot}</td><td>${r.from}</td><td>${r.to}</td>`;
    frag.appendChild(tr);
  }
  tb.appendChild(frag);
}
function logTrace(msg){
  if(!document.getElementById('traceEnabled')?.checked) return;
  const box=document.getElementById('traceLog'); if(box){ box.textContent += (box.textContent?'\n':'')+msg; box.scrollTop=box.scrollHeight; }
  try{ console.log(msg);}catch(e){}
}
document.getElementById('traceClear').onclick=()=>{ const box=document.getElementById('traceLog'); if(box) box.textContent=''; };

// load JSON
async function loadJSON(){
  const f = p => fetch(p, {cache:'no-cache'}).then(r=>r.ok?r.json():null).catch(()=>null);
  const caps = await (f('capacities.json') || f('data/capacities.json'));
  const rost = await (f('roster.json')     || f('data/roster.json'));
  const prfs = await (f('preferences.json')|| f('data/preferences.json'));
  if (!caps || !rost || !prfs) throw new Error('Place roster.json, preferences.json, capacities.json next to this file.');
  capMap.clear();
  for (const c of caps){
    const b=q(c.base), s=q(c.seat);
    const start=Number(c.startCapacity||c.start||0);
    const delta=Number(c.delta||0);
    capMap.set(key(b,s), {base:b, seat:s, start, delta});
  }
  roster = rost.map(x=>({ ...x, current:{ base:q(x.current.base), seat:q(x.current.seat) } }));
  prefs  = prfs;
  renderCapTable();
}

// seed vacancies from capMap
function seedVacFromCap(){
  Vac.clear();
  for (const [k,c] of capMap.entries()){ Vac.set(k,0); }
  const allowFO=document.getElementById('allowFoDelta')?.checked;
  for (const [k,c] of capMap.entries()){
    const d=Number(c.delta||0);
    if (c.seat==='CA' && d>0) vacInc(k,d);
    if (allowFO && c.seat==='FO' && d>0) vacInc(k,d);
  }
  renderOpen();
}

// award
const pinned=new Set();
const bestRank=new Map();
function award(p, fromK, toK, tag, rows){
  const [tb,ts]=toK.split('__'); const [fb,fs]=(fromK||'|').split('__');
  rows.push({pass:state.pass, action:"FILLED",  pilot:`SEN ${p.sen}`, from:"", to:`${tb} ${ts}`});
  if (fromK) rows.push({pass:state.pass, action:"CREATED", pilot:`SEN ${p.sen}`, from:`${fb} ${fs}`, to:""});
  moveOcc(p, fromK, toK);
  p.current={base:tb,seat:ts};
  const rNew=prefRank(p,tb,ts);
  bestRank.set(p.sen, Math.min(bestRank.get(p.sen)??Infinity, rNew));
  if (rNew===1) pinned.add(p.sen);
  state.moves.push({sen:p.sen,name:p.name||'',fromB:fb,fromS:fs,toB:tb,toS:ts});
}

// priority micro-pass
function priorityFill(sorted){
  const newly=drainNewlyOpened();
  for (const want of newly){
    for (const p of sorted){
      if (pinned.has(p.sen)) continue;
      const list=rankPrefs(p);
      for (const w of list){
        const toK=key(w.base,w.seat);
        if (toK!==want) continue;
        const have=vacAmt(toK); if (have<=0) continue;
        const rNow=bestRank.get(p.sen)??Infinity, rWish=prefRank(p,w.base,w.seat);
        if (rWish>=rNow) continue;
        const bpl=bplSatisfied(p,w,toK); if(!bpl.ok){ logTrace(`  REJECT: BPL (${bpl.reason})`); continue; }
        // award
        state.pass++;
        const fromK=key(p.current.base,p.current.seat);
        const rows=[];
        award(p, fromK, toK, 'priority', rows);
        vacDec(toK,1); if(fromK){ vacInc(fromK,1); noteOpen(fromK); }
        renderLedgerRows(rows); renderOpen(); renderNamesBySeniority();
        return true;
      }
    }
  }
  return false;
}

// run
async function run(){
  if (state.running) return;
  state.running=true; state.pass=0; state.moves=[];
  document.getElementById('ledgerBody').innerHTML='';
  document.getElementById('namesBySen').textContent='';
  document.getElementById('openVac').textContent='';

  try{
    await loadJSON();
    seedOccupants();
    seedVacFromCap();
    const sorted=roster.slice().sort((a,b)=>a.sen-b.sen);
    pinned.clear(); bestRank.clear();
    for(const p of sorted){
      const r0=prefRank(p,p.current.base,p.current.seat);
      bestRank.set(p.sen,r0); if(r0===1) pinned.add(p.sen);
    }

    // Vacancy-first (CA posted adds only)
    VacFirst:
    while(true){
      let awarded=false;
      for(const p of sorted){
        if (pinned.has(p.sen)) continue;
        const fromK=key(p.current.base,p.current.seat);
        const wants=rankPrefs(p).filter(w=>q(w.seat)==='CA');
        for(const w of wants){
          const toK=key(w.base,'CA');
          const have=vacAmt(toK);
          if (document.getElementById('traceEnabled')?.checked){
            const rNow=bestRank.get(p.sen)??Infinity, rWish=prefRank(p,w.base,'CA');
            logTrace(`[PASS ${state.pass}] Considering ${p.sen} ${p.name} for ${w.base} CA (Vac=${have}) | best=${rNow} wish=${rWish} BPL=${w.bpl_min||'-'}`);
          }
          if (have<=0){ logTrace('  REJECT: no vacancy'); continue; }
          const rNow=bestRank.get(p.sen)??Infinity, rWish=prefRank(p,w.base,'CA');
          if (rWish>=rNow){ logTrace(`  REJECT: not improvement (best=${rNow}, wish=${rWish})`); continue; }
          const bpl=bplSatisfied(p,w,toK); if(!bpl.ok){ logTrace(`  REJECT: BPL (${bpl.reason})`); continue; }
          // award
          state.pass++;
          const rows=[];
          award(p, fromK, toK, 'posted-add', rows);
          vacDec(toK,1); if(fromK){ vacInc(fromK,1); noteOpen(fromK); }
          renderLedgerRows(rows); renderOpen(); renderNamesBySeniority();
          awarded=true;
          continue VacFirst;
        }
      }
      if (priorityFill(sorted)) continue VacFirst;
      if (!awarded) break;
    }

    // Cascade
    Cascade:
    while(true){
      if (priorityFill(sorted)) continue Cascade;
      let awarded=false;
      for(const p of sorted){
        if (pinned.has(p.sen)) continue;
        const fromK=key(p.current.base,p.current.seat);
        const list=rankPrefs(p);
        for(const w of list){
          if (sameChoice(w.base,w.seat,p.current.base,p.current.seat)){ logTrace(`[PASS ${state.pass}] HIT STAY: ${w.base} ${w.seat}`); break; }
          const toK=key(w.base,w.seat);
          const have=vacAmt(toK);
          if (document.getElementById('traceEnabled')?.checked){
            const rNow=bestRank.get(p.sen)??Infinity, rWish=prefRank(p,w.base,w.seat);
            const occ=Occupants.get(toK)||new Set(); let seniorsAhead=0; for(const s of occ) if (s<p.sen) seniorsAhead++;
            logTrace(`[PASS ${state.pass}] Pref ${w.base} ${w.seat} (Vac=${have}) for ${p.sen} ${p.name} | best=${rNow} wish=${rWish} projPos=${seniorsAhead+1} BPL=${w.bpl_min||'-'}`);
          }
          if (have<=0){ logTrace('  REJECT: no vacancy'); continue; }
          const rNow=bestRank.get(p.sen)??Infinity, rWish=prefRank(p,w.base,w.seat);
          if (rWish>=rNow){ logTrace(`  REJECT: not improvement (best=${rNow}, wish=${rWish})`); continue; }
          const bpl=bplSatisfied(p,w,toK); if(!bpl.ok){ logTrace(`  REJECT: BPL (${bpl.reason})`); continue; }
          // award
          state.pass++;
          const rows=[];
          award(p, fromK, toK, 'cascade', rows);
          vacDec(toK,1); if(fromK){ vacInc(fromK,1); noteOpen(fromK); }
          renderLedgerRows(rows); renderOpen(); renderNamesBySeniority();
          awarded=true;
          continue Cascade;
        }
      }
      if (!awarded) break;
    }

    document.getElementById('status').textContent=`Done. Passes=${state.pass}, Moves=${state.moves.length}`;
  }catch(e){
    document.getElementById('status').textContent='Error: '+e.message;
    console.error(e);
  }finally{
    state.running=false;
  }
}

// wire
document.getElementById('runBtn').addEventListener('click', run);
document.getElementById('reloadBtn').addEventListener('click', ()=> loadJSON().then(()=>seedVacFromCap()));
document.getElementById('allowFoDelta').addEventListener('change', ()=> seedVacFromCap());
document.getElementById('traceClear').addEventListener('click', ()=>{ const t=document.getElementById('traceLog'); if(t) t.textContent=''; });

// boot
loadJSON().then(()=>{ seedVacFromCap(); document.getElementById('status').textContent='Ready.'; }).catch(e=>{
  document.getElementById('status').textContent='Load error — place roster.json, preferences.json, capacities.json next to this file.';
  console.error(e);
});
</script>
</body>
</html>
